;; Goku config for Karabiner-Elements
;; Edit this file — gokuw auto-compiles to karabiner.json
;;
;; Modifier shorthand:
;;   !  = mandatory   #  = optional
;;   C  = left_command    Q  = right_command
;;   T  = left_control    W  = right_control
;;   O  = left_option     E  = right_option
;;   S  = left_shift      R  = right_shift
;;   F  = fn              P  = caps_lock
;;   !! = hyper (cmd+ctrl+opt+shift)
;;   ## = optional any
;;
;; Sub-layer behavior:
;;   CleanShot (caps+c) = one-shot: action fires then exits mode
;;   Window (caps+w)    = hold: mode active while W held, release W to exit

{:profiles {:Default {:default true
                      :sim     50
                      :delay   500
                      :alone   500
                      :held    500}}

 :templates {:cleanshot "echo 'url cleanshot://%s' > /tmp/karabiner-hud.fifo ; echo 'hide' > /tmp/karabiner-hud.fifo"
             :aero      "/usr/local/bin/aerospace %s"
             :aero2     "/usr/local/bin/aerospace %s %s"
             :kb        "echo '%s' > /tmp/karabiner-scripts.fifo &"
             :hud       "echo '%s' > /tmp/karabiner-hud.fifo &"
             :open      "echo 'url %s' > /tmp/karabiner-hud.fifo &"
             :ime-save  "(/opt/homebrew/bin/macime set com.apple.keylayout.ABC --save --session-id %s; touch /tmp/karabiner-ime-active) &"
             :ime-load  "([ -f /tmp/karabiner-ime-active ] && rm /tmp/karabiner-ime-active && echo 'ime load --session-id %s --cjk-refresh' | /usr/bin/nc -U /tmp/riodelphino.macimed.sock) &"
             :ime-load-hud "([ -f /tmp/karabiner-ime-active ] && rm /tmp/karabiner-ime-active && echo 'ime load --session-id %s --cjk-refresh' | /usr/bin/nc -U /tmp/riodelphino.macimed.sock; echo 'hide caps' > /tmp/karabiner-hud.fifo) &"
             :ime-switch "$HOME/karabiner-config/scripts/ime-switch %s &"}

 :applications {:arc     ["^company\\.thebrowser\\.Browser$"]
                :raycast ["^com\\.raycast\\.macos$"]}
 :layers {}
 :simlayers {}

 :main [;; ===== Caps Lock: master key =====
        ;; Hold = caps-mode, tap alone = escape
        ;; Resets ALL sub-layer variables (universal escape hatch)
        ;; ##caps_lock = match regardless of held modifiers (prevents real Caps Lock)
        ;; Future idea: use modifier+caps combos as separate leader keys:
        ;;   [:!Ccaps_lock [["cmd-caps-mode" 1] ...] nil ...]   ;; Cmd+Caps → new mode
        ;;   [:!Scaps_lock [["shift-caps-mode" 1] ...] nil ...] ;; Shift+Caps → another
        ;; If adding those, change ## back to bare :caps_lock for the default,
        ;; and add specific !C / !S rules above it (Karabiner matches first hit).
        ;; Two rules: arc-bar-mode variant first (avoids shell_command conflict
        ;; between to_if_alone and to_after_key_up — only last shell runs)
        {:des "Caps Lock - master layer + reset all modes"
         :rules [;; When in arc bar mode: alone bakes HUD hide into its shell cmd
                 ;; so afterup has no shell_command to conflict with
                 [:##caps_lock [["caps-mode" 1]
                               ["cleanshot-mode" 0]
                               ["window-mode" 0]
                               ["resize-mode" 0]
                               [:hud "show caps"]]
                  ["arc-bar-mode" 1]
                  {:afterup [["caps-mode" 0]]
                   :alone [[:ime-load-hud "arc-bar"] ["arc-bar-mode" 0] :escape]}]
                 ;; Default: normal caps behavior
                 [:##caps_lock [["caps-mode" 1]
                               ["cleanshot-mode" 0]
                               ["window-mode" 0]
                               ["resize-mode" 0]
                               [:hud "show caps"]]
                  nil
                  {:afterup [["caps-mode" 0] [:hud "hide caps"]]
                   :alone :escape}]]}

        ;; ===== Sub-layer: CleanShot (caps + c) — one-shot =====
        ;; Hold caps, tap c, release caps, tap action key → fires & exits
        {:des "CleanShot mode"
         :rules [[:c [[:cleanshot "capture-area"]                ["cleanshot-mode" 0]] [:cleanshot-mode ["caps-mode" 0]]]
                 [:a [[:cleanshot "capture-area?action=annotate"] ["cleanshot-mode" 0]] [:cleanshot-mode ["caps-mode" 0]]]
                 [:v [[:cleanshot "capture-area?action=pin"]      ["cleanshot-mode" 0]] [:cleanshot-mode ["caps-mode" 0]]]
                 [:p [[:cleanshot "capture-previous-area"]        ["cleanshot-mode" 0]] [:cleanshot-mode ["caps-mode" 0]]]
                 [:f [[:cleanshot "capture-fullscreen"]           ["cleanshot-mode" 0]] [:cleanshot-mode ["caps-mode" 0]]]
                 [:w [[:cleanshot "capture-window"]               ["cleanshot-mode" 0]] [:cleanshot-mode ["caps-mode" 0]]]
                 [:s [[:cleanshot "scrolling-capture"]            ["cleanshot-mode" 0]] [:cleanshot-mode ["caps-mode" 0]]]
                 [:t [[:cleanshot "capture-text"]                 ["cleanshot-mode" 0]] [:cleanshot-mode ["caps-mode" 0]]]
                 [:r [[:cleanshot "record-screen"]                ["cleanshot-mode" 0]] [:cleanshot-mode ["caps-mode" 0]]]
                 [:h [[:cleanshot "open-history"]                 ["cleanshot-mode" 0]] [:cleanshot-mode ["caps-mode" 0]]]
                 [:escape [["cleanshot-mode" 0] [:hud "hide"]] [:cleanshot-mode]]]}

        ;; ===== Sub-layer: Window Management (caps + hold w) — hold =====
        ;; Hold caps, HOLD w, release caps, tap h/j/k/l repeatedly, release w to exit
        ;; Mode stays active as long as W is held
        {:des "Window mode"
         :rules [;; h/j/k/l = move focus (no mode reset — repeatable)
                 [:h [:aero "focus left"]                     [:window-mode]]
                 [:j [:aero "focus down"]                     [:window-mode]]
                 [:k [:aero "focus up"]                       [:window-mode]]
                 [:l [:aero "focus right"]                    [:window-mode]]
                 ;; shift + h/j/k/l = move window
                 [:!Sh [:aero "move left"]                    [:window-mode]]
                 [:!Sj [:aero "move down"]                    [:window-mode]]
                 [:!Sk [:aero "move up"]                      [:window-mode]]
                 [:!Sl [:aero "move right"]                   [:window-mode]]
                 ;; f = toggle fullscreen
                 [:f [:aero "fullscreen"]                     [:window-mode]]
                 ;; b = balance sizes
                 [:b [:aero "balance-sizes"]                  [:window-mode]]
                 ;; e = toggle layout
                 [:e [:aero "layout tiles horizontal vertical"] [:window-mode]]
                 ;; 1-9 = jump to workspace
                 [:1 [:aero "workspace 1"]                    [:window-mode]]
                 [:2 [:aero "workspace 2"]                    [:window-mode]]
                 [:3 [:aero "workspace 3"]                    [:window-mode]]
                 [:4 [:aero "workspace 4"]                    [:window-mode]]
                 [:5 [:aero "workspace 5"]                    [:window-mode]]
                 [:6 [:aero "workspace 6"]                    [:window-mode]]
                 [:7 [:aero "workspace 7"]                    [:window-mode]]
                 [:8 [:aero "workspace 8"]                    [:window-mode]]
                 [:9 [:aero "workspace 9"]                    [:window-mode]]
                 ;; shift + 1-9 = move window to workspace
                 [:!S1 [:aero "move-node-to-workspace 1"]     [:window-mode]]
                 [:!S2 [:aero "move-node-to-workspace 2"]     [:window-mode]]
                 [:!S3 [:aero "move-node-to-workspace 3"]     [:window-mode]]
                 [:!S4 [:aero "move-node-to-workspace 4"]     [:window-mode]]
                 [:!S5 [:aero "move-node-to-workspace 5"]     [:window-mode]]
                 [:!S6 [:aero "move-node-to-workspace 6"]     [:window-mode]]
                 [:!S7 [:aero "move-node-to-workspace 7"]     [:window-mode]]
                 [:!S8 [:aero "move-node-to-workspace 8"]     [:window-mode]]
                 [:!S9 [:aero "move-node-to-workspace 9"]     [:window-mode]]
                 ;; r = enter resize sub-mode
                 [:r [["resize-mode" 1] [:hud "show resize"]] [:window-mode]]]}

        ;; ===== Sub-sub-layer: Resize mode (window → r → ...) =====
        ;; Stays active for repeated resizes, escape or release W to exit
        {:des "Resize mode"
         :rules [[:h [:aero2 "resize" "width -50"]  [:resize-mode]]
                 [:j [:aero2 "resize" "height +50"] [:resize-mode]]
                 [:k [:aero2 "resize" "height -50"] [:resize-mode]]
                 [:l [:aero2 "resize" "width +50"]  [:resize-mode]]
                 [:escape [["resize-mode" 0] [:hud "show window"]] [:resize-mode]]]}

        ;; ===== Right Command → Hyper (Cmd+Ctrl+Opt) =====
        {:des "Right Command → Hyper (Cmd+Ctrl+Opt)"
         :rules [[:##right_command :!TOleft_command]]}

        ;; ===== Cmd+Space → toggle IME =====
        ;; Uses ime-switch helper (proper CJK initialization with window trick)
        ;; Variable "ime-english" tracks current state (1=ABC, 0=Zhuyin)
        {:des "Cmd+Space → toggle IME"
         :rules [[:!Cspacebar [[:ime-switch "toggle"] ["ime-english" 0]] ["ime-english" 1]]
                 [:!Cspacebar [[:ime-switch "toggle"] ["ime-english" 1]] ["ime-english" 0]]]}

        ;; ===== Right Shift shortcuts: force IME =====
        {:des "Right Shift+E/Z force IME"
         :rules [[:!Re [[:ime-switch "com.apple.keylayout.ABC"] ["ime-english" 1]]]
                 [:!Rz [[:ime-switch "com.apple.inputmethod.TCIM.Zhuyin"] ["ime-english" 0]]]]}

        ;; ===== Per-app: Arc Browser =====
        {:des "Arc - caps+j/k spaces, caps+s sort tabs, cmd+\\ toggle pinned"
         :rules [[:j [:kb "arc-next-space"]  [:arc ["caps-mode" 1]]]
                 [:k [:kb "arc-prev-space"]  [:arc ["caps-mode" 1]]]
                 [:s [:kb "arc-sort-tabs"]   [:arc ["caps-mode" 1]]]
                 ;; Cmd+\ toggle: expand/collapse pinned tabs via daemon
                 [:!Cbackslash [:kb "arc-toggle-pinned"] [:arc]]]}

        ;; ===== Per-app: Arc - Smart IME switching for address bar =====
        ;; Cmd+T/L: save current IME, switch to English, pass key through
        ;; Enter/Esc/Cmd+T/Cmd+L again: restore previous IME, pass key through
        ;; Uses macime with session-id "arc-bar" for save/restore
        ;; :ime-load goes through macimed daemon socket (not CLI) because:
        ;; 1. macime load --session-id is broken in CLI v4.2.0 (validation bug)
        ;; 2. Daemon has run loop needed for --cjk-refresh window trick
        ;; 3. --cjk-refresh forces proper CJK sub-mode initialization
        {:des "Arc - IME switching for address bar"
         :rules [;; Enter bar mode: save IME → English → pass key through
                 [:!Ct [[:ime-save "arc-bar"] ["arc-bar-mode" 1] :!Ct] [:arc ["arc-bar-mode" 0]]]
                 [:!Cl [[:ime-save "arc-bar"] ["arc-bar-mode" 1] :!Cl] [:arc ["arc-bar-mode" 0]]]
                 ;; Exit bar mode: restore IME → pass key through
                 [:!Ct [[:ime-load "arc-bar"] ["arc-bar-mode" 0] :!Ct] [:arc ["arc-bar-mode" 1]]]
                 [:!Cl [[:ime-load "arc-bar"] ["arc-bar-mode" 0] :!Cl] [:arc ["arc-bar-mode" 1]]]
                 [:return_or_enter [[:ime-load "arc-bar"] ["arc-bar-mode" 0] :return_or_enter] [:arc ["arc-bar-mode" 1]]]
                 [:escape [[:ime-load "arc-bar"] ["arc-bar-mode" 0] :escape] [:arc ["arc-bar-mode" 1]]]]}

        ;; ===== Hyper key app-gated shortcuts =====
        ;; Raycast listens for these globally; we block them when not in the right app
        ;; so they only fire in context. Without these rules, the key passes through
        ;; and Raycast catches it.
        {:des "Hyper gates - block shortcuts outside target app"
         :rules [;; Hyper+A → Raycast Arc search: swallow when NOT in Arc
                 [:!CTOa :vk_none [:!arc :!raycast]]]}

        ;; ===== Caps Lock layer: entry points to sub-layers =====
        {:des "Caps mode - sub-layer entries"
         :rules [;; CleanShot: one-shot (tap c, release)
                 [:c [["cleanshot-mode" 1] [:hud "show cleanshot"]] ["caps-mode" 1]]
                 ;; Window: hold-based (HOLD w, release w to exit)
                 [:w [["window-mode" 1] [:hud "show window"]] ["caps-mode" 1]
                  {:afterup [["window-mode" 0] ["resize-mode" 0] [:hud "hide"]]}]]}]}
